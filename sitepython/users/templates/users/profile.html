{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'learning/css/profile.css' %}">
{% endblock %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å - Python Learning{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-background">
        <div class="profile-shape shape-1"></div>
        <div class="profile-shape shape-2"></div>
        <div class="profile-shape shape-3"></div>
    </div>

    <div class="profile-header fade-in-up">
        <div class="avatar-container">
            <div class="profile-avatar" id="avatarPreview">
                <img src="{{ user.image.avatar.url }}" alt="{{ user.username }}" class="avatar-image" id="avatarImage">
            </div>
            <form method="post" enctype="multipart/form-data" class="avatar-form" id="avatarForm">
                {% csrf_token %}
                <input type="file" id="avatarInput" name="avatar" accept="image/*" class="avatar-input" hidden>
                <div class="avatar-buttons">
                    <label for="avatarInput" class="btn btn-outline-primary avatar-change-btn">
                        <span class="btn-icon">üì∑</span>
                        –°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä
                    </label>
                    <button type="button" class="btn btn-gradient-primary avatar-save-btn" id="avatarSaveBtn" disabled>
                        <span class="btn-icon">üíæ</span>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-outline-secondary avatar-cancel-btn" id="avatarCancelBtn" style="display: none;">
                        <span class="btn-icon">‚ùå</span>
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
            <div class="avatar-messages" id="avatarMessages">
                {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <div class="alert-icon">
                        {% if message.tags == 'success' %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}
                    </div>
                    <div class="alert-content">{{ message }}</div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
        <h1 class="profile-title">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>
        <p class="profile-subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.username }}!</p>
    </div>

    <div class="profile-content">
        <div class="profile-card fade-in-up" style="animation-delay: 0.1s;">
            <div class="profile-card-header">
                <div class="profile-card-icon">üë§</div>
                <h3>–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            </div>
            <div class="profile-info">
                <div class="info-item">
                    <span class="info-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                    <span class="info-value">{{ user.username }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{ user.email|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                    <span class="info-value">{{ user.date_joined|date:"d.m.Y" }}</span>
                </div>
            </div>
        </div>

        <div class="profile-card fade-in-up" style="animation-delay: 0.2s;">
            <div class="profile-card-header">
                <div class="profile-card-icon">üìä</div>
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—É—á–µ–Ω–∏—è</h3>
            </div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">–†–µ—à–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">0</div>
                    <div class="stat-label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
                </div>
            </div>
        </div>

        <div class="profile-card fade-in-up" style="animation-delay: 0.3s;">
            <div class="profile-card-header">
                <div class="profile-card-icon">‚ö°</div>
                <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
            </div>
            <div class="profile-actions">
                <a href="{% url 'lessons' %}" class="btn btn-outline-primary btn-action">
                    <span class="btn-icon">üìö</span>
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                </a>
                </a>
                <form method="post" action="{% url 'users:logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-gradient-danger btn-action">
                        <span class="btn-icon">üö™</span>
                        –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.getElementById('avatarInput');
    const avatarImage = document.getElementById('avatarImage');
    const avatarSaveBtn = document.getElementById('avatarSaveBtn');
    const avatarCancelBtn = document.getElementById('avatarCancelBtn');
    const avatarForm = document.getElementById('avatarForm');
    const avatarMessages = document.getElementById('avatarMessages');
    const originalAvatarSrc = avatarImage.src;
    let selectedFile = null;

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
    avatarInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', '–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB');
                this.value = '';
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                showMessage('error', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                this.value = '';
                return;
            }

            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarImage.src = e.target.result;
                avatarSaveBtn.disabled = false;
                avatarCancelBtn.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // –û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
    avatarCancelBtn.addEventListener('click', function() {
        avatarImage.src = originalAvatarSrc;
        avatarInput.value = '';
        avatarSaveBtn.disabled = true;
        avatarCancelBtn.style.display = 'none';
        selectedFile = null;
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ —á–µ—Ä–µ–∑ AJAX
    avatarSaveBtn.addEventListener('click', function() {
        if (!selectedFile) {
            showMessage('error', '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            return;
        }

        const formData = new FormData();
        formData.append('avatar', selectedFile);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        avatarSaveBtn.disabled = true;
        const originalText = avatarSaveBtn.innerHTML;
        avatarSaveBtn.innerHTML = '<span class="btn-icon">‚è≥</span> –ó–∞–≥—Ä—É–∑–∫–∞...';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
        fetch('{% url "users:profile" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('success', '–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
                avatarImage.src = data.avatar_url + '?t=' + new Date().getTime();
                originalAvatarSrc = avatarImage.src;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                avatarInput.value = '';
                avatarSaveBtn.disabled = true;
                avatarCancelBtn.style.display = 'none';
                selectedFile = null;
            } else {
                showMessage('error', data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞');
            }
        })
        .catch(error => {
            showMessage('error', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            avatarSaveBtn.disabled = false;
            avatarSaveBtn.innerHTML = originalText;
        });
    });

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showMessage(type, text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.innerHTML = `
            <div class="alert-icon">${type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'}</div>
            <div class="alert-content">${text}</div>
        `;
        
        avatarMessages.appendChild(messageDiv);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transition = 'opacity 0.5s ease';
            setTimeout(() => messageDiv.remove(), 500);
        }, 5000);
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    const existingMessages = avatarMessages.querySelectorAll('.alert');
    existingMessages.forEach(message => {
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transition = 'opacity 0.5s ease';
            setTimeout(() => message.remove(), 500);
        }, 5000);
    });
});
</script>
{% endblock %}